<!DOCTYPE html>
<html>
<head>
    <title>Sensor Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 20px;
        }
        .chart-container {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            height: 300px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .data-table th {
            background-color: #f2f2f2;
        }
        .history-container {
            display: none;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>

    <h1>Sensor Dashboard</h1>

    <!-- Device Status -->
    <h3 id="deviceStatus" style="color:green;">ðŸŸ¢ Device Connected</h3>

    <!-- Button Instead of Link -->
    <button onclick="toggleHistory()">View Received Data Table</button>

    <!-- LIVE SENSOR TABLE -->
    <table class="data-table" id="liveDataTable">
        <tr>
            <th>Sensor 1</th><th>Sensor 2</th><th>Sensor 3</th><th>Sensor 4</th>
            <th>Sensor 5</th><th>Sensor 6</th><th>Sensor 7</th><th>Sensor 8</th>
            <th>Sensor 9</th><th>Sensor 10</th><th>Sensor 11</th><th>Sensor 12</th>
            <th>Sensor 13</th><th>Sensor 14</th><th>Sensor 15</th><th>Sensor 16</th>
        </tr>
        <tr id="currentData">
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
        </tr>
    </table>

    <!-- HISTORY TABLE (Hidden Initially) -->
    <div class="history-container" id="historyContainer">
        <h3>Full Data History</h3>
        <table class="data-table" id="historyTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Sensor 1</th><th>Sensor 2</th><th>Sensor 3</th><th>Sensor 4</th>
                    <th>Sensor 5</th><th>Sensor 6</th><th>Sensor 7</th><th>Sensor 8</th>
                    <th>Sensor 9</th><th>Sensor 10</th><th>Sensor 11</th><th>Sensor 12</th>
                    <th>Sensor 13</th><th>Sensor 14</th><th>Sensor 15</th><th>Sensor 16</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>

    <div class="grid-container" id="chartsContainer"></div>

<script>

const charts = [];
const maxDataPoints = 50;

// Create charts
function createCharts() {
    const container = document.getElementById('chartsContainer');
    for (let i = 0; i < 16; i++) {
        const canvas = document.createElement('canvas');
        const div = document.createElement('div');
        div.className = 'chart-container';
        div.appendChild(canvas);
        container.appendChild(div);

        const chart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: `Sensor ${i + 1}`,
                    data: [],
                    borderColor: `hsl(${(i * 360 / 16)}, 70%, 50%)`,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 }
            }
        });
        charts.push(chart);
    }
}

// Toggle history table
function toggleHistory() {
    const container = document.getElementById("historyContainer");
    container.style.display = container.style.display === "none" ? "block" : "none";
}

// Update Live Dashboard
function updateDashboard(data) {
    const cells = document.getElementById('currentData').getElementsByTagName('td');
    for (let i = 0; i < data.length; i++) {
        cells[i].textContent = data[i].toFixed(2);
    }

    const timestamp = new Date().toLocaleTimeString();
    for (let i = 0; i < charts.length; i++) {
        charts[i].data.labels.push(timestamp);
        charts[i].data.datasets[0].data.push(data[i]);

        if (charts[i].data.labels.length > maxDataPoints) {
            charts[i].data.labels.shift();
            charts[i].data.datasets[0].data.shift();
        }

        charts[i].update();
    }
}

// Load Latest Data
setInterval(async () => {
    const response = await fetch('/latest');
    const data = await response.json();
    if (data.values && data.values.length === 16) {
        updateDashboard(data.values);
    }
}, 300);

// Load History Data
setInterval(async () => {
    const response = await fetch('/history');
    const data = await response.json();

    const body = document.getElementById("historyBody");
    body.innerHTML = "";

    data.history.forEach((row, index) => {
        let tr = "<tr><td>" + (index + 1) + "</td>";
        row.forEach(val => {
            tr += "<td>" + val.toFixed(2) + "</td>";
        });
        tr += "</tr>";
        body.innerHTML += tr;
    });

}, 300);

// Device Status
setInterval(async () => {
    const response = await fetch('/status');
    const data = await response.json();
    const status = document.getElementById("deviceStatus");

    if (data.device === "connected") {
        status.textContent = "ðŸŸ¢ Device Connected";
        status.style.color = "green";
    } else {
        status.textContent = "ðŸ”´ Device Disconnected";
        status.style.color = "red";
    }
}, 300);

createCharts();

</script>

</body>
</html>
